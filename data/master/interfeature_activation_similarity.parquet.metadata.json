{
  "created_at": "2025-11-10T13:22:06.284892",
  "script_version": "4.0",
  "architecture": "dual_ngram_with_position_tracking",
  "sae_id": "google--gemma-scope-9b-pt-res--layer_30--width_16k--average_l0_120",
  "total_rows": 824,
  "schema": {
    "feature_id": "UInt32",
    "sae_id": "Categorical",
    "semantic_pairs": "List(Struct([Field('similar_feature_id', UInt32), Field('decoder_similarity', Float32), Field('pattern_type', Utf8), Field('semantic_similarity', Float32), Field('char_jaccard', Float32), Field('word_jaccard', Float32), Field('main_prompt_ids', List(UInt32)), Field('similar_prompt_ids', List(UInt32)), Field('num_comparisons', UInt32), Field('max_char_ngram', Utf8), Field('max_char_ngram_size', UInt8), Field('max_word_ngram', Utf8), Field('max_word_ngram_size', UInt8), Field('main_char_ngram_positions', List(Struct([Field('prompt_id', UInt32), Field('positions', List(Struct([Field('token_position', UInt16), Field('char_offset', UInt8)])))]))), Field('similar_char_ngram_positions', List(Struct([Field('prompt_id', UInt32), Field('positions', List(Struct([Field('token_position', UInt16), Field('char_offset', UInt8)])))]))), Field('main_word_ngram_positions', List(Struct([Field('prompt_id', UInt32), Field('positions', List(UInt16))]))), Field('similar_word_ngram_positions', List(Struct([Field('prompt_id', UInt32), Field('positions', List(UInt16))])))]))",
    "lexical_pairs": "List(Struct([Field('similar_feature_id', UInt32), Field('decoder_similarity', Float32), Field('pattern_type', Utf8), Field('semantic_similarity', Float32), Field('char_jaccard', Float32), Field('word_jaccard', Float32), Field('main_prompt_ids', List(UInt32)), Field('similar_prompt_ids', List(UInt32)), Field('num_comparisons', UInt32), Field('max_char_ngram', Utf8), Field('max_char_ngram_size', UInt8), Field('max_word_ngram', Utf8), Field('max_word_ngram_size', UInt8), Field('main_char_ngram_positions', List(Struct([Field('prompt_id', UInt32), Field('positions', List(Struct([Field('token_position', UInt16), Field('char_offset', UInt8)])))]))), Field('similar_char_ngram_positions', List(Struct([Field('prompt_id', UInt32), Field('positions', List(Struct([Field('token_position', UInt16), Field('char_offset', UInt8)])))]))), Field('main_word_ngram_positions', List(Struct([Field('prompt_id', UInt32), Field('positions', List(UInt16))]))), Field('similar_word_ngram_positions', List(Struct([Field('prompt_id', UInt32), Field('positions', List(UInt16))])))]))"
  },
  "processing_stats": {
    "features_processed": 824,
    "total_pairs_compared": 3295,
    "semantic_pairs": 195,
    "lexical_pairs": 847,
    "no_pattern_pairs": 2292,
    "features_with_insufficient_decoder_similar": 0,
    "features_with_no_activations": 0
  },
  "result_stats": {
    "features_with_any_pairs": 563,
    "features_with_semantic_pairs": 111,
    "features_with_lexical_pairs": 499,
    "total_semantic_pairs": 195,
    "total_lexical_pairs": 847,
    "total_all_pairs": 1042,
    "mean_pairs_per_feature": 1.2645631067961165
  },
  "config_used": {
    "features_path": "data/master/features.parquet",
    "activation_examples_path": "data/master/activation_examples.parquet",
    "activation_embeddings_path": "data/master/activation_embeddings.parquet",
    "output_path": "data/master/interfeature_activation_similarity.parquet",
    "sae_id": "google--gemma-scope-9b-pt-res--layer_30--width_16k--average_l0_120",
    "processing_parameters": {
      "top_n_decoder_similar": 4,
      "num_quantiles": 4,
      "samples_per_quantile": 4,
      "embedding_window_size": 32,
      "char_ngram_window_size": 1,
      "word_ngram_window_size": 11,
      "char_ngram_sizes": [
        2,
        3,
        4,
        5
      ],
      "word_ngram_sizes": [
        1,
        2,
        3
      ],
      "semantic_threshold": 0.3,
      "char_jaccard_threshold": 0.7,
      "word_jaccard_threshold": 0.8,
      "position_samples_per_quantile": 2
    },
    "description": "Configuration for calculating inter-feature activation similarity metrics between decoder-similar features with positional n-gram tracking for visualization",
    "processing_notes": {
      "expected_features": 16384,
      "processing_strategy": "decoder_similarity_based_pairing",
      "handle_insufficient_examples": "use_all_available",
      "embeddings_source": "pre_computed_from_4_act_embeddings.py",
      "dependencies": [
        "3_features_parquet.py must be run first (for decoder_similarity field)",
        "4_act_embeddings.py must be run first (for pre-computed embeddings)",
        "5_act_similarity.py must be run first (for activation_examples.parquet)"
      ],
      "primary_key_fields": [
        "feature_id",
        "sae_id"
      ],
      "comparison_strategy": "cross_feature_pairwise",
      "pairwise_computation": "16 main examples \u00d7 16 selected examples for calculation; 8\u00d78 for position tracking",
      "version": "4.0",
      "architecture": "dual_ngram_with_position_tracking",
      "pattern_classification": "semantic and/or lexical (pairs can be in both lists)",
      "position_tracking": "char_offset and token positions stored per prompt_id for frontend highlighting"
    },
    "schema_info": {
      "table_name": "interfeature_activation_similarity",
      "version": "4.0",
      "field_descriptions": {
        "feature_id": "Main feature ID (0-16383)",
        "sae_id": "SAE model identifier",
        "semantic_pairs": "Feature pairs with semantic similarity above threshold (pattern=Semantic)",
        "lexical_pairs": "Feature pairs with lexical similarity above threshold (pattern=Lexical)",
        "similar_feature_id": "ID of the decoder-similar feature being compared",
        "decoder_similarity": "Decoder weight cosine similarity from features.parquet",
        "pattern_type": "Classification: Semantic or Lexical (pairs can be in both lists)",
        "semantic_similarity": "Average pairwise cosine similarity of embeddings",
        "char_jaccard": "Character-level n-gram Jaccard similarity",
        "word_jaccard": "Word-level n-gram Jaccard similarity",
        "main_prompt_ids": "List of prompt IDs analyzed from main feature (max 16 for calculation)",
        "similar_prompt_ids": "List of prompt IDs analyzed from similar feature (max 16 for calculation)",
        "num_comparisons": "Total number of pairwise comparisons performed",
        "max_char_ngram": "Most frequent character n-gram text",
        "max_char_ngram_size": "Size of most frequent character n-gram",
        "max_word_ngram": "Most frequent word n-gram text",
        "max_word_ngram_size": "Size of most frequent word n-gram",
        "main_char_ngram_positions": "List of {prompt_id, positions: [{token_position, char_offset}]} for main feature (8 examples with positions)",
        "similar_char_ngram_positions": "List of {prompt_id, positions: [{token_position, char_offset}]} for similar feature (8 examples with positions)",
        "main_word_ngram_positions": "List of {prompt_id, positions: [token_positions]} for main feature (8 examples with positions)",
        "similar_word_ngram_positions": "List of {prompt_id, positions: [token_positions]} for similar feature (8 examples with positions)"
      },
      "notes": {
        "v4_changes": "Removed both_pairs list. Pairs meeting both conditions are now added to both semantic_pairs and lexical_pairs. Added position tracking fields for frontend visualization.",
        "frontend_integration": "Frontend joins this data with activation_display.parquet on feature_id to get full example data. Position fields enable precise n-gram highlighting."
      }
    }
  }
}